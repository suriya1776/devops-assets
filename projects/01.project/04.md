# Deployment in AKS cluster

### Create a Azure AKS cluster using terraform

### [Source file](tech_asset/azure_aks.tf)

### AKS cluster details

- Get the subcription ID , resource group and cluster name 

```sh
az account show --query id --output tsv
az aks list --query '[].{name:name,resourceGroup:resourceGroup}' --output table
```

- Exceute the below command where azure cli is present and connected to you cluster, for creating a rbac

```sh
az ad sp create-for-rbac --name "github-actions-aks" --sdk-auth --role contributor \
    --scopes /subscriptions/<sub ID>/resourceGroups/<Resource group name>/providers/Microsoft.ContainerService/managedClusters/<Cluster name>
```

- Will get the json responce , copy the response somewhere safe , those will be used as credentials to connect to the azure cluster

```json
{
  "clientId": "21dd61ba-90ea-42aa-8e70-8a52bb31",
  "clientSecret": "~CY8Q~TuJIICvLWlIp~-W9z1KZtNcLa.qauB",
  "subscriptionId": "4d19167d-fe08-4336-8c1f-ef2ddc6",
  "tenantId": "5f95ae70-3df4-4b27-95cb-f04315597",
  "activeDirectoryEndpointUrl": "https://login.microsoftonline.com",
  "resourceManagerEndpointUrl": "https://management.azure.com/",
  "activeDirectoryGraphResourceId": "https://graph.windows.net/",
  "sqlManagementEndpointUrl": "https://management.core.windows.net:8443/",
  "galleryEndpointUrl": "https://gallery.azure.com/",
  "managementEndpointUrl": "https://management.core.windows.net/"
}
```

## Configuring the github actions workflow

- Create a secret for the following AKS_CLUSTER_NAME,AZURE_CREDENTIALS,AZURE_RESOURCE_GROUP and enter the value we got from above commands

## [Workflow file](https://github.com/suriya1776/microservices-demo/blob/47352e256e3e9aca5fd9950380f8ad5da091b876/.github/workflows/aks_deployment.yml)

- The workflow will be executed everyday and also can be triggered manually , This will automatically detect the latest Image pushed to the registry and deploy it in the cluster

- Here below you can see , the header has a text Hot product , I am going to simulate a change, here

![Pipeline status](assets/ss_18.png)

- I am changing in html code to Hot new products 

![Simulate change](assets/ss_19.png)

- Image builing pipeline is triggered 

![Pipeline status](assets/ss_16.png)

![Pipeline status](assets/ss_17.png)

-  Frontend pod is deployment with the latest Image change , change can be verfied in the UI

![Pod deployment](assets/ss_20.png)

![Change in UI](assets/ss_21.png)

